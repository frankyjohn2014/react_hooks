import React,{useState, useEffect, useContext} from 'react'
import {Link, Redirect} from "react-router-dom";
import useFetch,{error} from 'hooks/useFetch'
import UseLocalStorage from 'hooks/useLocalStorage'
import {CurrentUserContext} from 'context/currentUser'
import BackendErrorMassages from 'pages/authentication/components/backendErrorMassages'

const Authentication = props => {
    const isLogin = props.match.path === '/login'
    const pageTitle = isLogin ? 'Sign In' : 'Sign Up'
    const descriptionLink = isLogin ? '/register' : '/login'
    const descriptionText = isLogin ? 'Need an account?' : 'Have an account'
    const apiUrl = isLogin ? 'users/login' : 'users'
    const [username, setUsername] = useState('')
    const [email, setEmail] = useState('')
    const [password, setPassword] = useState('')
    const [succesLogin, setSuccesLogin] = useState(false)
    const [{response, isLoading, error}, doFetch] = useFetch(apiUrl)
    const [token, setToken] = UseLocalStorage('token')
    const [, dispatch] = useContext(CurrentUserContext)

    const handleSubmit = (event) => {
        const user = isLogin ? {email, password} : {email, password, username}

        event.preventDefault()
        doFetch({method:'post',
            data: {
                user
            }})
    }


    useEffect(() => {
        if(!response) {
            return
        }
        setToken(response.user.token)
        setSuccesLogin(true)
        dispatch({type: 'SET_AUTHORIZED', payload: response.user})
    }, [response,setToken, dispatch])

    if(succesLogin) {
        return <Redirect to='/'/>
    }

    return (
        <div className="auth-login">
            <div className="col-md-6 offset-md-3 col-xs-12">
                <h1 className="text-xs-center">{pageTitle}</h1>
                <p>
                    <Link to={descriptionLink}>{descriptionText}</Link>
                </p>
                {error && <BackendErrorMassages BackendError={error.errors}/>}
                <form onSubmit={handleSubmit}>
                    {!isLogin && (
                        <div className="mb-3">
                            <label htmlFor="exampleInputEmail1" className="form-label">Username</label>
                            <input type="username" className="form-control" id="exampleInputusername" aria-describedby="emailHelp"
                                   value={username} onChange={event => setUsername(event.target.value)}
                            />
                            <div id="emailHelp" className="form-text">Enter your username
                            </div>
                        </div>
                    )}
                    <div className="mb-3">
                        <label htmlFor="exampleInputEmail1" className="form-label">Email address</label>
                        <input type="email" className="form-control" id="exampleInputEmail1" aria-describedby="emailHelp"
                               value={email} onChange={event => setEmail(event.target.value)}
                        />
                            <div id="emailHelp" className="form-text">We'll never share your email with anyone else.
                            </div>
                    </div>
                    <div className="mb-3">
                        <label htmlFor="exampleInputPassword1" className="form-label">Password</label>
                        <input type="password" className="form-control" id="exampleInputPassword1"
                        value={password} onChange={event => setPassword(event.target.value)}
                        />
                    </div>
                    <div className="mb-3 form-check">
                        <input type="checkbox" className="form-check-input" id="exampleCheck1"/>
                            <label className="form-check-label" htmlFor="exampleCheck1">Check me out</label>
                    </div>
                    <button type="submit" className="btn btn-primary" disabled={isLoading}>{pageTitle}</button>
                </form>
            </div>
        </div>
    )
}

export default Authentication